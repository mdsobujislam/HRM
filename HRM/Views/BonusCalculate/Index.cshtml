@model IEnumerable<HRM.Models.BonusCalculate>
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row justify-content-center">
    <div class="col-lg-12">
        <div class="card shadow-sm rounded-3">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">📋 Create Bonus</h5>
            </div>
            <div class="card-body">
                <form asp-action="Insert" method="post" enctype="multipart/form-data">
                    <div class="row g-3">
                        <!-- Bonus Type -->
                        <div class="col-md-4">
                            <label for="BonusTypeId" class="form-label fw-semibold">Bonus Type</label>
                            <select id="BonusTypeId" name="BonusTypeId" class="form-select select2" required>
                                <option value="">-- Select Bonus Type --</option>
                                @foreach (var item in (List<SelectListItem>)ViewBag.BonusTypeList)
                                {
                                    <option value="@item.Value">@item.Text</option>
                                }
                            </select>
                        </div>

                        <!-- Bonus Date -->
                        <div class="col-md-4">
                            <label for="BonusDate" class="form-label fw-semibold">Date</label>
                            <input type="date" class="form-control" id="BonusDate" name="BonusDate" required>
                        </div>

                        <!-- Percentage -->
                        <div class="col-md-4">
                            <label for="Percentage" class="form-label fw-semibold">Percentage (%)</label>
                            <input type="number" step="0.01" class="form-control" id="Percentage" name="Percentage" required placeholder="Enter Percentage">
                        </div>

                        <!-- Branch -->
                        <div class="col-md-3">
                            <label for="BranchId" class="form-label fw-semibold">Branch</label>
                            <select id="BranchId" name="BranchId" class="form-select select2">
                                <option value="">-- Select Branch --</option>
                                @foreach (var item in (List<SelectListItem>)ViewBag.BranchList)
                                {
                                    <option value="@item.Value">@item.Text</option>
                                }
                            </select>
                        </div>

                        <!-- Department -->
                        <div class="col-md-3">
                            <label for="DepartmentId" class="form-label fw-semibold">Department</label>
                            <select id="DepartmentId" name="DepartmentId" class="form-select select2">
                                <option value="">-- Select Department --</option>
                                @foreach (var item in (List<SelectListItem>)ViewBag.DepartmentList)
                                {
                                    <option value="@item.Value">@item.Text</option>
                                }
                            </select>
                        </div>

                        <!-- Designation -->
                        <div class="col-md-3">
                            <label for="DesignationId" class="form-label fw-semibold">Designation</label>
                            <select id="DesignationId" name="DesignationId" class="form-select select2" required>
                                <option value="">-- Select Designation --</option>
                                @foreach (var item in (List<SelectListItem>)ViewBag.DesignationList)
                                {
                                    <option value="@item.Value">@item.Text</option>
                                }
                            </select>
                        </div>

                        <!-- Employee -->
                        <div class="col-md-3">
                            <label for="EmployeeId" class="form-label fw-semibold">Employee</label>
                            <select id="EmployeeId" name="EmployeeId" class="form-select select2" required>
                                <option value="">-- Select Employee --</option>
                                @foreach (var item in (List<SelectListItem>)ViewBag.EmployeeList)
                                {
                                    <option value="@item.Value">@item.Text</option>
                                }
                            </select>
                        </div>

                        <!-- Submit Button -->
                        <div class="col-12 text-end mt-3">
                            <button type="submit" class="btn btn-primary px-5">
                                💾 Submit
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>





@section Scripts {

    <script>

                        $(document).ready(function () {
            // Initially enable all
            $("#BranchId, #DepartmentId, #DesignationId, #EmployeeId").prop("disabled", false);

            function handleDisable(currentId) {
                let branch = $("#BranchId");
                let department = $("#DepartmentId");
                let designation = $("#DesignationId");
                let employee = $("#EmployeeId");

                // Always start by enabling all
                branch.prop("disabled", false);
                department.prop("disabled", false);
                designation.prop("disabled", false);
                employee.prop("disabled", false);

                // If Employee selected → disable Branch, Department, Designation
                if (currentId === "EmployeeId" && employee.val()) {
                    branch.prop("disabled", true);
                    department.prop("disabled", true);
                    designation.prop("disabled", true);
                }

                // If Branch, Department, or Designation selected → disable Employee
                else if (
                    (currentId === "BranchId" && branch.val()) ||
                    (currentId === "DepartmentId" && department.val()) ||
                    (currentId === "DesignationId" && designation.val())
                ) {
                    employee.prop("disabled", true);
                }
            }

            // Bind change event to all dropdowns
            $("#BranchId, #DepartmentId, #DesignationId, #EmployeeId").on("change", function () {
                handleDisable(this.id);
            });
        });







        function submitData(){
        document.getElementById("Id").value = "";
            document.getElementById("BonusTypeId").value ="";
            document.getElementById("BranchId").value ="";
            document.getElementById("DesignationId").value ="";
            document.getElementById("DepartmentId").value ="";
            document.getElementById("EmployeeId").value ="";
            document.getElementById("BonusDate").value = "";
            document.getElementById("Percentage").value = "";
            document.getElementById("Submit").textContent = "Submit";
        }


                function editBranch(id, slotName, branchId,DepartmentId,DesignationId,startHour, startMinute, dutyHour, dutyMinute, endHour, endMinute) {
            document.getElementById("Id").value = id;
            document.getElementById("SlotName").value = slotName;
            document.getElementById("DepartmentId").value =DepartmentId;
            document.getElementById("BranchId").value =branchId;
            document.getElementById("DesignationId").value =DesignationId;
            document.getElementById("StartHour").value = startHour;
            document.getElementById("StartMinute").value = startMinute;
            document.getElementById("DutyHour").value = dutyHour;
            document.getElementById("DutyMinute").value = dutyMinute;
            document.getElementById("EndHour").value = endHour;
            document.getElementById("EndMinute").value = endMinute;

            document.getElementById("addDepartmentModalLabel").textContent = "Edit Duty Slot";
            document.getElementById("modalSubmitText").textContent = "Update";
        }

        document.querySelectorAll('.deleteForm').forEach(function (form) {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                Swal.fire({
                    title: 'Are you sure?',
                    text: "This will permanently delete the branch.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        form.submit();
                    }
                });
            });
        });




            //strat Branch , Department and Designation mapping/Filter

        // Branch change → Load Departments
        $('#BranchId').on('change', function () {
            var branchId = $(this).val();
            var departmentDropdown = $('#DepartmentId');
            var designationDropdown = $('#DesignationId');

            departmentDropdown.empty().append('<option value="">Loading...</option>');
            designationDropdown.empty().append('<option value="">-- Select Designation --</option>');

            if (branchId) {
                $.ajax({
                    url: '/SalaryCalculation/GetDepartmentsByBranch',
                    type: 'GET',
                    data: { branchId: branchId },
                    success: function (data) {
                        departmentDropdown.empty().append('<option value="">-- Select Department --</option>');
                        $.each(data, function (i, item) {
                            departmentDropdown.append('<option value="' + item.id + '">' + item.name + '</option>');
                        });
                    },
                    error: function () {
                        departmentDropdown.empty().append('<option value="">Error loading departments</option>');
                    }
                });
            } else {
                departmentDropdown.empty().append('<option value="">-- Select Department --</option>');
            }
        });

        // Department change → Load Designations
        $('#DepartmentId').on('change', function () {
            var departmentId = $(this).val();
            var designationDropdown = $('#DesignationId');

            designationDropdown.empty().append('<option value="">Loading...</option>');

            if (departmentId) {
                $.ajax({
                    url: '/SalaryCalculation/GetDesignationsByDepartment',
                    type: 'GET',
                    data: { departmentId: departmentId },
                    success: function (data) {
                        designationDropdown.empty().append('<option value="">-- Select Designation --</option>');
                        $.each(data, function (i, item) {
                            designationDropdown.append('<option value="' + item.id + '">' + item.name + '</option>');
                        });
                    },
                    error: function () {
                        designationDropdown.empty().append('<option value="">Error loading designations</option>');
                    }
                });
            } else {
                designationDropdown.empty().append('<option value="">-- Select Designation --</option>');
            }
        });

        //End Branch , Department and Designation mapping/Filter


    </script>

}

